# 谢耀武

> 2016-08-29 到 2016-09-02

## 基础模板+平台方向汇报

目前基础模板+机制是我这边负责，平台相关是@张屾负责，后续平台、机制逐步熟悉后会穿插着跟进。非常感谢@小琴的指导和帮助～

我们整理了目前的需求和文档，建立了：

* [icafe需求空间 - 圣玛利亚平台](http://newicafe.baidu.com/issues/space/ps-santa/?filter=40493&c=[type][status][owner][createTime][22797])
* [wiki - 文档、接口、规范](http://wiki.baidu.com/pages/viewpage.action?pageId=207951419)

## 最近上线

* 开发js拼mip、sf2的方法，08-26ci代码并给出相关文档
* 配合www整个使用moplus的组件并替换相关有问题的文件
* 一休机器人稳定运行发布
* 整理平台的文档
* 升级平台代码的配置，减少svn diff的文件
* 平台预览时接入qa沙盒自动化链接分析修复
* 平台cr页面添加【新增模板】的标识

## 基础+机制

### 目标

* 满足业务需求 - 满足常用需求，对于特殊需求提供技术支持
* 更高的易用性 - api、通用机制
* 文档更健全 - base的文档已经升级完成，其他文档待一步步去重构升级
* js基础代码自动化测试 - 理想情况下要覆盖aladdin在www-wise里的基础方法

### 任务list

#### 0. aladdin-wise上线分包处理

现在发现wise中的上线包`ala_template.tar.gz`文件很大，目前35M，导致最近每天的svn ci失败，必须手动ci单个文件后走平台，跟@小琴沟通将该包拆成3个子文件夹包，08-29拆分后试用上线，发现问题，已回滚，正在梳理单个文件夹上线的方案。ps:试用上线、回滚不影响线上，只是我在平台里操作

#### 1. 推动删除pad.tpl

近期发现aladdin-wise上线包(ala_template.tar.gz)的体积越来越大，现在单个包是35M，梳理了上线包，发现编译后上线包里有 838 个pad.tpl.php，压缩前占85M，压缩后占10M。

由于生成的文件内容同iphone.tpl一致，正在跟odp@yichan评估aladdin-wise弃用pad.tpl直接使用iphone.tpl的方案，odp上线后aladdin-wise将删除pad.tpl文件

收益:

1. 模板不用单独维护pad.tpl内容
2. 流程时间减少，包大小减少

功能 | 删除前 | 删除后 | diff
--- | --- | --- | ---
fis3编译 | 93.00s | 93.73s | +0.73s
smarty预编译  | 793s  |  514s  |  -279s
ala_template.tar.gz包大小 | 34M | 21M | -13M


#### 2. 梳理www-wise里的aladdin相关代码

跟@雪冉沟通目录规范，并升级相关的文件，这是个很费的活，重构时会考虑aladdin基础库的单元测试（这个正在调研）

[http://sfe.baidu.com/#/搜索结果页/无线搜索整体规范/www-wise基础UI+JS规范+&+重构](http://sfe.baidu.com/#/搜索结果页/无线搜索整体规范/www-wise基础UI+JS规范+&+重构)

测试用例的优点：

1. 代码更有保障
1. 测试是个趋势
1. 测试用例会让后续的升级更稳定、更安全

#### 3. showlamp长线模板支持

针对showlamp平台化配置aladdin小图标逻辑，现对aladdin-wise的基础模板c_base基础模板升级，代码已完成，预计09-02周五上午上线，上线后会推动整个foot的升级为规范化

c_base的showlamp升级上线后会推动整个foot升级，升级后会支持长线的show lamp和shower，也算foot相关的一个里程碑吧。下一个就是标题～

#### 4. 哥伦布组的展开、收起子卡数量不够时出bug修复

[http://newicafe.baidu.com/issue/ps-santa-37/show?from=page](http://newicafe.baidu.com/issue/ps-santa-37/show?from=page)

#### 5. 调研c_base中`title block`的需求

发现大量模板在重写title的block，收集常用需求，并优化c_base中的代码实现和文档，需要考虑到重写方便、可调框、官网图标

#### 6. 跟@qijian、@yuanwei再对下模板编译时fis合并amd文件

## 平台方向

> 按优先级排序

### 功能性优化 - 高优 - @张屾

1. 针对card类型的模板也需要有确认效果的过程, 需要熟悉odp的渲染流程 (进行中)
1. 针对编辑的模板提供下载压缩包的功能
1. 模板列表支持展开收起
1. 调研哥伦布是否需要平台线下预览
1. 调研sf2是否需要平台线下预览

<a name="pro" id="pro"></a>
### 针对产品规范的平台需求 - 高优 - @谢耀武

添加对产品落地规范化的特型展示需求，辅助统一化、规范化和进度

> 按优先级排序，以09-02（周五）开始，高优跟进，但可能并行着其他项目

1. 在 [【模板浏览】](http://tpldev.baidu.com/#explore) 页面打标签 - 主要对有展现的模板打上特型的标签以方便快速查找，初步定这些case - **2.5天**
    * 有绿色showurl
    * 没有showurl+没有站点来源
    * 没有foot
    * sigma2.0
    * 有showlamp - aladdin小图标
    * 没有showlamp - aladdin小图标
    * 包含sf2.0页面
    * 标题中有蓝色【官网】
2.  每天展现PV低于1000的卡片，把PV显示在页面上，高PV的那些卡片不展现PV数字，这就不涉及保密了。 - **0.5天**
3.  写上卡片上线的日期 - **0.5天**
4.  在卡片下方列出本卡片拥有的所有tag（天气、按钮、图片、表格、推荐等等这些），这样能看是否全面，标注是否有缺失 - **0.5天**
1. 线下定期跑出sf1.0的模板 - **0.5天**
1. 线下定期跑出sigma1.0的模板 - **0.5天**
1. 在 [【展现分析】](http://tpldev.baidu.com/#tpllogs) 页面添加资源类型显示和按资源类型筛选 - **2天**
5.  统计里面，加上每天的总共模板数，记录历史，观察增涨情况，从而能够看到咱们1个月、1个Q下来，模板增加了多少 - **2天**
1.  把连续30天没有流量的卡片 - 功能done，已经有人跟进

### 规范检查优化

1. 数据转码检查 escape:none的使用做代码检查 (方案待定)
1. 数据结构检查 对于$tplData的使用做规范检查 (方案待定)
1. class明明检查 (待定)
1. 跨模板引用检查 - include、inline、extends跨模板检查
1. pad.tpl内容检查
1. 新增模板黑名单检查（不能以指定的名为文件名）

### 重构积分系统

针对积分模块进行重构, 想在前端代码不大范围修改的情况下, 引入静态资源管理以及构建机制

针对目前积分管理存在的不合理处进行优化, 解放值周人员的手动操作频次

1. 支持天级自动通知
1. 支持周级自动通知
1. 考虑是否使用新的前端架构

### 跟pm.open对接

已跟@liuchen沟通，当面沟通下该方面的对接，比如删除模板时的接口等

### 建立平台文档 - ing

1. 现有代码、目录说明
1. 相关服务器说明
1. svn路径说明
1. 新规范说明
1. 后端接口新路径说明
1. 前端新架构说明

## aladdin-wise 上线优化

### 背景

针对目前的上线进度，分析整个上线时间点，给出可优化的时间点

#### 全量 - 2个人上线

* 平台创建->沙盒编译: 21分钟
* 沙盒确认: 2分钟
* 平台ci+agile操作: 6分钟
* 静态文件全量: 13分钟
* 模板单台: 5分钟
* 模板单台确认: 7分钟
* 模板全量: 1小时30分
* 整体上线: 2小时40分钟

### 普通编译 - 19个人

* 平台创建->沙盒编译: 17分钟
* 沙盒确认: 30分钟
* 平台ci+agile操作: 7分钟
* 静态文件全量: 14分钟
* 模板单台: 5分钟
* 模板单台确认: 29分钟
* 模板全量: 1小时29分
* 整体上线: 3小时02分钟

### card - 1个人

* 平台创建->沙盒编译: 2分钟
* 沙盒确认: 5分钟
* 平台ci+agile操作: 7分钟
* 静态文件全量: 14分钟
* 模板单台: 1分钟
* 模板单台确认: 23分钟
* 模板全量: 24分
* 整体上线: 1小时25分钟

> 以上时间点是比较顺利的，如果有沙盒重新编译要再加时间

### 结论

对比全量上线、多人上线、card上线，总结如下：

* wise的全量时间为1小时30分钟，可以优化分组并发数来提升时间
* 发现在上线确认时很是耗时，特别是人多的时候，可以明确整个时间点，到点就编译，第一时间在找里@相关人，短时间不确认则打电话咨询

### 优化

1. 推动删除pad.tpl文件，会有减少837个文件编译，并且会减少整个tar包体积
1. 每天10:30、15:30准时沙盒编译，如果时间点内没有达到上线状态，则不带其上线
1. 沙盒编译后群里@相关的人员确认，等一休的@api完善后可自动@相关的人，沙盒5分钟后直接单台上线
1. 单台完成后群里@相关的人员确认，1分钟未回复的直接打电话，保证在10分钟之内确认效果

优化后预期的时间：20个人

* 平台创建->沙盒编译: 15分钟 - 减少pad.tpl后
* 沙盒确认: 5分钟 - 考虑废弃
* 平台ci+agile操作: 7分钟
* 静态文件全量: 14分钟
* 模板单台: 5分钟
* 模板单台确认: 10分钟 - 如果沙盒取消则时间长点
* 模板全量: 30-60分钟
* 整体上线: 1小时30分钟-2小时

## 最近的问题

1. 基础模板+机制包括哪些？
1. sf2.0、mip的相关接口谁去维护？
    1. 如果基础模板负责那些相关的更新、需求谁去同步？
