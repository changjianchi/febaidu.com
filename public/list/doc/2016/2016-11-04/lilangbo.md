# 李浪波

> 从2016-10-31到2016-11-04           

## 本周相关工作和 mip 规范

1. mip-validator 校验规则

    背景与目标

        mip-validator 是一个支持 npm 安装，同时支持网页校验的 MIP 校验工具， 校验规则就是为校验工具提供一套符合 MIP 规范的规则。

    完成情况

    - 校验规则升级

        ```
        1. 不允许 html 标签中含有 style 属性

        2. 不允许 html 标签中含有 on开头的属性（如onclick），但是允许适用 on

        规则升级，a 标签 href 属性 支持：

        - tel:xxx
        - mailto:xxx
        ```

    - spider校验框架长线方案

        1104:长线方案 站长平台 RD 采用 c++版本开发，预计开发两周测试一周，已启动开发。

        目前处于低优维护状态

2、涉及规范更新：
    
    DONE，整体方案已经完成

3、广告：
    1）1103:反屏蔽5.0和39健康网一起联调成功，并上线一个广告位继续观察

4、top 站点：

    1) 审批通过4个，并已经上线

        待审批3个

5、mip aladdin 机制打通

        见下面单独的项目描述

6、mip cache
    
    cache页面实时校验：todo 未启动  

    清 cache 接口： http://wiki.baidu.com/pages/viewpage.action?pageId=235318047 特殊渠道：

    100s 10个 单站点 稳定性测试 站点级别的配置

    站长帐号   站长平台  才有权清站点的 url 

    站点先从站长平台登录，拿到已有或重新生成的 private_key，用于清 cache。

    5mins 清完 稳定性测试

    kv 存储需要机器：key 的存储；本周

    长线渠道：

    52mins 自动更新

## mip aladdin 机制打通

### 背景：

    在引入阿拉丁资源中，有部分的外跳链接是 MIP 化的页面，可以使用 MIP 页在结果页打开的方式。例如目前线上 query:"奥运” 的阿拉丁结果（并非自动打标，而是硬编码到数据中）
    MIP 页有严格的规范，可以参照上面的 MIP 介绍，需要进行严格的打标记、屏蔽、退化等方式保证线上的良好用户体验

### 排期计划：
    
    排期为：
        10.17 ~ 10.21  编码
        10.24 ~ 10.28  测试
        10.31 ~ 11.4   前后端的联调
        11.7 ~ 11.11   上线

    具体分模块排期：

        建库工作        （雷杰），        9月19日可以启动，    10月21日完成开发测试工作
        错误日志回写 （孙巍巍），        非核心依赖，        依赖阿拉丁死链检测长线方案，短线先不支持
        平台工作        （浩玮），        10月初可以启动，     10月底完成相关开发测试工作
        Spdier           （孙权），        10月18号可以启动，   11月初完成相关开发测试工作
        AE相关工作    （陈刚，晓辉）， 非主要路径，             9月16日前完成具体工作的方案确认

### 进展：

```
    1104:
    1、模板平台支持 kv 和 MINI 资源的配置，本周开发完成，并在11月18号之前提供具体的操作 wiki @春杰
    2、阿拉丁模板@兆明、模板平台@春杰 和 数据建库@王鹏 11月3号——11月9号联调
    3、数据建库 @王鹏 和 tera 联调 时间点定在下周内 11月11号之前，具体时间请 @晓荣 邮件给出，联调1天测试5天
    4、整体上线依赖 EC 的校验模块的上线，具体时间点在11月30号之前 @程刚
```

    错误日志回写:
        讨论了在 GSS/ala-root/US/odp/模板的现有情况的可行性，结论是都不能快速短线支持，由于阿拉丁架构在推阿拉丁死链检测，也是同一波 RD 开发，和这个需求类似，所以结论是和阿拉丁死链检测同时进行，长线计划需巍巍给出排期，目前看年底有可能

    MIP阿拉丁的检测详细方案:

    ```
        阿拉丁：
            （1）       建库时，取站长认为符合mip规范的xml里的原始url，调用spider提供的基于Tera的mip类型的查询api接口，得到该url是检测过符合mip规范，检测过不符合mip规范，未检测等状态，用于确认是否能以mip形式进行展示。
            （2）       对于建库集合，基于自己的需求，如页面是否变化，是否进行去重等，过滤出待检测的阿拉丁url集合
            （3）       调度spider提供的抓取检测api，发送到Spider进行抓取。
        Spider：
            （1）       主要提供两个API接口：
            查询MIP类型的接口，查询Tera表里这个url的mip状态等提供，秒级返回；
            抓取检测API接口，接收阿拉丁的检测需求。
            （2）       MIP检测功能开发：
            存储上：实时死链系统，新建Tera表，存储阿拉丁的url符合mip规范的信息，上次检测时间等，并设置一定时间的TTL。
            开发上：接收阿拉丁的检测需求，发送到spider进行抓取检测；
            对于阿拉丁来源，且符合MIP规范的url，实时写入Tera中。
            检测上，spider还是会基于站点的压力控制，进行均衡的抓取，避免把站点抓挂的情况。
    ```

        流程如下图：
![image](http://gitlab.baidu.com/psfe/ala-weeklyreport/uploads/b5403c0435d30828077c83553579e0da/image.png)

        Mip url年底大概在5000w（总量*5%） 左右，按照更新频率、增量验证等因素来看，每天需要送检的大概在20%左右，大概1000w

### 阿拉丁接入短线方案：
    
    各个资源方着急自己所负责的mip资源上线，可以按照奥运的方案上线:阿拉丁的 mip url 标记完全由 xml 控制，直接站长标记

    缺点：
        1、mip 合法性和规范性无法保证，存在不符合规范也会展现到线上的风险，各资源方需要人工check资源的风险性；
        2、长线方案OK之后，需要迁移数据。

    优点：可以即时上线。





## 核心代码(齐健)

    基础代码完善  
```
1、组件迁移新工程 - 已迁移，还需要再跟进一段时间，待稳定  
2、静态文件上线流程及引入方案  
    进度：周五开发完毕  
    排期：下周内达到可用状态  
3、MIP页面闪动问题  
    进度：经讨论后，采用了用户按需处理的方案，如果用户页面有闪动问题，则使用我们提供的解决方案解决。  
          目前解决方案已经开发完成，测试中，待上线  
4、速度打点  
    进度：时间有delay，需要跟mip.js一起上线。目前在测试中  
5、mip.js测试  
    最近mip.js有几个大的改动  包含代码规范整理、编译升级、速度打点、BUG修复。目前这些修改已经打包提测，  
    周四出测试结果，周末跟进测试中的问题，下周上线新版本。

```

## 组件  

### 一、本周完成内容：
    1、新增站长组件7个：
    mip-ck-script  康网的问答详情页面的js代码
    mip-down-comment  pc6 支持文章详情页的评论
    mip-down-hideshow pc6 支持文章详情页的显示隐藏切换
    mip-ck-basecss 传客 自有业务逻辑内MIP页面的基础css
    mip-ck-course-detail 传客 自有业务详情页整体交互组件
    mip-ifeng-ppt 凤凰网 文章详情页的幻灯
    mip-ifeng-pptdetail 凤凰网 支持幻灯

    mip-ad 广告  优化 baidu-wm-ext类型的代码方式


### 二、bug fix、优化、开发后续计划：

    mip-accordion 折叠节点 基本功能可用，11月11号升级支持可以默认展开的功能
    mip-appdl 下载  基本功能可用，11月11号修复fixed悬浮在百度 mip 下的滑动体验问题
    mip-list 列表 开发中，release 时间待定
    mip-sidebar 侧边栏   测试中，11月11号release
    mip-stats-baidu 百度统计  支持一个页面引入两个百度统计标签 11月11号release

    审核中的组件：mip-hnr-rem、mip-html-tabs



### 三、release组件列表（未包含站长自身开发的组件）
    mip-carousel 多图轮播
    mip-iframe iframe
    mip-img 图片
    mip-pix 统计
    mip-video 视频
    mip-anim 动图
    mip-audio 音频播放
    mip-stats-baidu 百度统计
    mip-fixed 悬浮布局
    mip-form 表单
    mip-html-os 操作系统
    mip-lightbox 弹层
    mip-link 跳转链接
    mip-share 分享
    mip-stats-tianrun 天润统计
    mip-ad 广告

    