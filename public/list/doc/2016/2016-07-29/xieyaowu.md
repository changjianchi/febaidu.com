# 谢耀武

> 从2016-07-25到2016-07-29

## 一休机器人

### 背景

由于现在aladdin开发上线人员来自各个团队，目前200人左右，在目前上线过程中（如编译、单台、全量）都需要值周人手动的同步到群里，并多次发现各外部团队（如知道、文库、多模等）遇到问题时对接口人不太清楚的情况，由此推出一休机器人，可以在群里发指定的指令机器人会自动的回复相关的内容，以解决接口人明确、通报方便的目的，后续还可以接口平台的一些自动流程提示等

### 要实现的功能

* 值周 - 显示本值周fe和值周bug
* 接口人 - 显示aladdin各模块的接口人
* 我的积分 - 返回当前用户的最新积分情况
* 主动公告 - 可以一休后台主动往群里发送公告

### 排期

于07-29（周五）上线

## 单模板上线

### 背景

1. 目前模板上线只是同步文件，无需重启服务，适合数据配送的方式
1. 目前863上线上线需要打包上线，这种方式上线时间3.5小时左右(多人)，并且需要单日所有需求打包，期间的确认和等待比较耗时。需要提升上线效率
1. 多人上线在确认过程中需要等所有人都ready了才能下一步，导致整个上线效率不高
1. 目前上线方式，如果在上线过程中，有某个模板有问题，需要针对整次上线进行回滚，造成了没必要的回滚次数

结果以上现在新对aladdin-wise模块使用mis+noah方式上线，统一上线静态文件和模板文件，多并发上线

### 预计收益

1. 模板达到上线状态无需等待，直接操作上线，并且可同步上线15个模板（15个窗口）
1. 单次模板上线时间要比现有方式有很大提升，预计要比现有方式**快1.4倍**
1. 由于是单模板上次，回滚率和回滚风险大大降低
1. 模板owner直接操作上线，并且上线时间提升，对人力上有很大的优化

### 上线时间点对比

* 863上线时间点是按正常无delay的时间点算，如果有确认时delay或者模板有问题可能时间更长
* mis+noah上线时间点是预估的

![image](http://gitlab.baidu.com/psfe/ala-weeklyreport/uploads/0958ec61d6b188859beb4f5f9552b2e4/image.png)

### mis+noah 上线流程

![image](http://gitlab.baidu.com/psfe/ala-weeklyreport/uploads/d108b1089fd4c02f6204ef87fbeb70b8/image.png)

### 排期

* 07-18 至 08-12：平台开发（4周）
* 08-15 至 08-19：mis+noah联调+测试（1周）
* 08-22 至 08-25：内测试运行（1周）
* 08-29：上线（周一）

### 当前进度

截至07-18已整理整个流程，并且找mis@宝占当面沟通了下，对mis有个大概认识，准备07-19再找noah@杨涛哥沟通下noah权限相关、流程相关的事情，然后开始设计整个技术方案和数据表

### 技术的流程

1. 模板沙盒编译后插入到上线任务中，平台自动生成tar包，并执行相关逻辑判断后推送到mis，由mis分发给noah机器组
    * 当前并发达到上限：插入队列并等待
    * 没有静态文件
        * 当前是否有上级任务静态文件依赖
            * 有：插入队列，等待上级任务静态文件完成后开始上线
            * 没有：直接并发上线
    * 有静态文件
        * 当前是否有上级任务静态文件依赖
            * 有：插入队列，等待上级任务静态文件完成后开始上线当前任务静态文件
            * 没有：插入队列开始上线静态文件，完成后上线模板
    * 在等待过程中用户可取消任务，取消任务会自动状态恢复为【开发中】
1. 单台：静态文件上完后，自动触发模板单台上线，单台完成后，提示用户，并倒计时2.40分钟（需要server记录单台时间），在指定时间内没有确认下一步则自动取消任务，并恢复到【上线准入】状态，需要再次编译才能上线（需要找@小琴确认这里）
1. 全量：当在单台确认下一步后，自动全量，完成后提示全量完成
1. 当次模板上线完成后判断队列里是否有需要上线的文件，有则继续自动上线

### 依赖

1. 需要@小琴评审整个机制的实现和数据库的设计，辛苦小琴
1. 在单台/全量中回滚问题，需要找@小琴沟通方案 @耀武
1. 联调前联系mis@宝占协助 @耀武
1. NOAH上线通路建立：联系yangtao08协助 @耀武
1. 静态文件快速通道申请OP审核和模块经理：li.zheng,baisong，wuyou @耀武
1. QA稳定性测试：联系雨梅处理 @耀武
1. 确认节假日、周末上线的相关问题 @耀武


### 单模板上线禁止list

1. 跨模板include
1. 其他待定

### 后续的优化

1. 整个上线、回滚、取消会直接跟积分系统挂勾，自动加、减分
1. 队列里重复模板的判断