# 李浪波

> 从2016-9-26到2016-9-30           

## 本周相关工作和 mip 规范

1. mip-validator 校验规则【无更新】

    背景与目标

        mip-validator 是一个支持 npm 安装，同时支持网页校验的 MIP 校验工具， 校验规则就是为校验工具提供一套符合 MIP 规范的规则。

    完成情况

    - 校验规则升级

        ```
        1. 不允许 html 标签中含有 style 属性

        2. 不允许 html 标签中含有 on开头的属性（如onclick），但是允许适用 on
        ```

    - spider校验框架长线方案

        上周调研 xsd 在校验框架中的可行性，结论是不可行

            * 不推荐使用XSD Parser来校验HTML

            * JSON规则与XSD规则相互转换不可行

            * XSD不适合描述MIP规则

        本周进行沟通，spider RD 根据前端的校验版本的规则描述，调研可行的长线解决方案，下面是结论：

            ```
                0.mip校验短线方案支持
                目前站长平台mip校验短线方案9月21日19点上线，可以支持1000万/天的校验量。

                1.spider-ec上线1.0.3版本预计下周上线完成；1.0.4版本预计10月中上线
                后续支持月级别的需求满足，也请ps fe同学每个月月初汇总一次需求，统一提给spider接口人@孙权。

                2.mip校验框架技术支持（长线方案）
                目前评估全人力开发需要4周，整体开发，测试，联调和上线预计7周；目前开发人力预计11月中有人力投入进行开发。
            ```

        校验快速通道：

            ```
                MIP校验快速通道方案如下
                站长平台提交的url，通过对应的sitemap生成对应的url list。spider同学针对此部分url list，使用本机的node MIP校验工具，进行单独的离线MIP校验，校验完成后进行CCDB库的MIP信息回灌。

                MIP FE提供离线的node校验工具（含校验规则），供spider使用。目前已提供npm版本的工具。

                站长平台同学进行快速通道机制的整体研发，校验使用node版本的离线校验工具。
                9月20号 ready

            ```

2、资讯 mip 迁移  工作量一评估，11天/人,陈锐跟进，已在迁移  无进展，等待人力

3、涉及规范更新：


    ```
        <link rel="standardhtml"
         href="https://m.baidu.com/static/ala/mip/mip-demo.html”>
        变成
        <link rel="canonical"
         href="https://m.baidu.com/static/ala/mip/mip-demo.html”>

        修改原因：
        符合w3c 规范
        rel=”canonical” 这个标签已经推出很久了，canonical 是 Google、雅虎、微软等搜索引擎一起推出的一个标签，它的主要作用是用来解决由于网址形式不同内容相同而造成的内容重复问题。这个标签对搜索引擎作用非常大，简单的说它可以让搜索引擎只抓取你想要强调的内容。

        整体节奏：
        1、@程刚 支持识别canonical标签的 h5页和 MIP 页对应，辛苦给下工作量和排期
        2、官网同步规范更改通知，并给出切换成<link rel=“canonical" 的 deadline
         @王培 @佳莹 ，
        与此同时，@张灿辛苦通知站长进行同步修改，务必在
         deadline 之前改完
        3、前后端两个校验模块更新
        @王培 @孙权 校验在 10月30号 时需要支持如下逻辑： 
        mip页 不能缺少<link rel=“canonical” ，
        但同时页面如果有<link rel="standardhtml”也是能通过验证
    ```


3、SF-MIP 增加手百调起小耳朵逻辑，bug list fixing，体验升级计划已给出,已上线。本周沟通 odp 需求，准备将域名的 path变成 sf/mip，同步的 url 进行加密处理

    odp path规则已上线，sf路由规则还未上线，阿拉丁侧未修改

    下线手百调起小耳朵逻辑，和其他浏览器逻辑相同

4、日志对齐方案：

    sf-mip的 iframe 用 tc 链接打开，能够在实验组和对照组的都在 tc 上进行评估，9月22号上线一版，发现手百特殊逻辑上有 bug，已经回滚处理，新开发版本已提测，预计9月26号已上线

5、网盟广告：计费功能已上线，mip 开流量验证阶段，验证一周，在同步验收效果，预计10月9号开流量

6、top 站点：

    1) 审批上线通过5个外部开发组件,并均已上线

        mip-39ad
        
        mip-fh-ad

        mip-vd-popup

        mip-vd-tabs

        mip-html-os

        待审批3个

    2) 解答各种开发问题，需要 todo 的 list 如下：


        ```
            GA 统计支持计划

            ajax 数据渲染支持【todo，10月份计划，云加速统一解决方案】

            阿里妈妈广告支持【todo，10月份计划】

            form 增加可以清空 input 的方法【todo，10月份计划】

            登陆验证组件实现问题【todo，10月份计划】

            有些私有业务组件，不希望或不能（公司规定）放在github上面【github维护混淆后代码】
        ```

        下周一起和@沈洲todo



7、fixed 在 sf-mip 下的技术方案已产出，在测试兼容性，等兼容性测试完成后开完成组件功能。

    已上线:![文档地址](https://www.mipengine.org/doc/4-widget/4-customize-widget/fixed-widget.html)

8、mip cache url 改写

    背景：

        目前 mip 页走 mip cache，如果 http 请求用'/'打头，会去找 cache 的域名，导致404，需要 cache 将这些规则的地方加上全路径

    进展：

        需要支持改写的规则 list 已经提供给 OP 陈刚，cache 改写已经上线了初版

        本周支持css的 background-image

        存在问题：

            mip-ad 广告的 src 属性未支持，由于资讯的 mip-ad 的规范和我们不一致，需要@陈锐迁移

9、mip aladdin 机制打通

        见下面单独的项目描述

## mip aladdin 机制打通

### 背景：

    在引入阿拉丁资源中，有部分的外跳链接是 MIP 化的页面，可以使用 MIP 页在结果页打开的方式。例如目前线上 query:"奥运” 的阿拉丁结果（并非自动打标，而是硬编码到数据中）
    MIP 页有严格的规范，可以参照上面的 MIP 介绍，需要进行严格的打标记、屏蔽、退化等方式保证线上的良好用户体验

### 排期计划：
    
    排期为：
        10.17 ~ 10.21  编码
        10.24 ~ 10.28  测试
        10.31 ~ 11.4   前后端的联调
        11.7 ~ 11.11   上线

    具体分模块排期：

        建库工作        （雷杰），        9月19日可以启动，    10月21日完成开发测试工作
        错误日志回写 （孙巍巍），        非核心依赖，        依赖阿拉丁死链检测长线方案，短线先不支持
        平台工作        （浩玮），        10月初可以启动，     10月底完成相关开发测试工作
        Spdier           （孙权），        10月18号可以启动，   11月初完成相关开发测试工作
        AE相关工作    （陈刚，晓辉）， 非主要路径，             9月16日前完成具体工作的方案确认

### 进展：

    错误日志回写:
        讨论了在 GSS/ala-root/US/odp/模板的现有情况的可行性，结论是都不能快速短线支持，由于阿拉丁架构在推阿拉丁死链检测，也是同一波 RD 开发，和这个需求类似，所以结论是和阿拉丁死链检测同时进行，长线计划需巍巍给出排期，目前看年底有可能

    MIP阿拉丁的检测详细方案:

    ```
        阿拉丁：
            （1）       建库时，取站长认为符合mip规范的xml里的原始url，调用spider提供的基于Tera的mip类型的查询api接口，得到该url是检测过符合mip规范，检测过不符合mip规范，未检测等状态，用于确认是否能以mip形式进行展示。
            （2）       对于建库集合，基于自己的需求，如页面是否变化，是否进行去重等，过滤出待检测的阿拉丁url集合
            （3）       调度spider提供的抓取检测api，发送到Spider进行抓取。
        Spider：
            （1）       主要提供两个API接口：
            查询MIP类型的接口，查询Tera表里这个url的mip状态等提供，秒级返回；
            抓取检测API接口，接收阿拉丁的检测需求。
            （2）       MIP检测功能开发：
            存储上：实时死链系统，新建Tera表，存储阿拉丁的url符合mip规范的信息，上次检测时间等，并设置一定时间的TTL。
            开发上：接收阿拉丁的检测需求，发送到spider进行抓取检测；
            对于阿拉丁来源，且符合MIP规范的url，实时写入Tera中。
            检测上，spider还是会基于站点的压力控制，进行均衡的抓取，避免把站点抓挂的情况。
    ```

        流程如下图：
![image](http://gitlab.baidu.com/psfe/ala-weeklyreport/uploads/b5403c0435d30828077c83553579e0da/image.png)

        Mip url年底大概在5000w（总量*5%） 左右，按照更新频率、增量验证等因素来看，每天需要送检的大概在20%左右，大概1000w

### 阿拉丁接入短线方案：
    
    各个资源方着急自己所负责的mip资源上线，可以按照奥运的方案上线:阿拉丁的 mip url 标记完全由 xml 控制，直接站长标记

    缺点：
        1、mip 合法性和规范性无法保证，存在不符合规范也会展现到线上的风险，各资源方需要人工check资源的风险性；
        2、长线方案OK之后，需要迁移数据。

    优点：可以即时上线。





## 核心代码(齐健)

    基础代码完善  
```
    1、目录整改 - done  
    2、整体增加单测 - done  
    3、补充注释 - doing　
    4、新增mip-extensions，并迁移两个典型组件 - done
```

## 组件  

### 1. mip-askad

#### 背景与目标
    
    根据资源方需求，增加两种定制广告，增加底部悬浮广告的 pk 策略

    - SET_CLASS_PARAMS
    - SET_KEYWORW_PARAMS

#### 完成情况

- 进度：已上线（9.30）
- 预览地址：暂无

#### 效果图

### 2. mip-video

#### 背景与目标
    
    内置 视频 组件，支持 iframe 播放

#### 完成情况

- 进度：已上线（9.19）
- 预览地址：暂无

#### 效果图

- 暂无

### 3. mip-fixed

#### 背景与目标
    
    fix 浮层支持关闭按钮，同时修复关闭按钮点击穿透bug

#### 完成情况

- 进度：已上线（9.21）
- 预览地址：暂无

#### 效果图

- 暂无

### 4. mip-lightbox

#### 背景与目标
    
    点击按钮展开浮层

#### 完成情况

- 进度：测试 BUG 修复中
- 预览地址：http://fedev.baidu.com/~wangpei07/mip/lightbox/lightbox-mip.html

#### 效果图

<table>
    <tr>
        <td><img src='../2016-09-23/img/wangpei07/wp01.png' width="300"></td>
        <td><img src='../2016-09-23/img/wangpei07/wp02.png' width="300"></td>
    </tr>
</table>

### 5. mip-sidebar

#### 背景与目标
    
    通用侧边栏组件，支持左边侧边栏和右边侧边栏

#### 完成情况

- 进度：测试 BUG 修复中（9.21）
- 预览地址：http://fedev.baidu.com/~wangpei07/mip/sidebar/mip-sidebar.html

#### 效果图

<table>
    <tr>
        <td><img src='../2016-09-09/img/wangpei07/wp03.png' width="320"></td>
    </tr>
</table>

### 6. mip-fit-text（接@传梼）

#### 背景与目标
    
    自适应字体组件，根据屏幕窗口的变化能够自适应字体

#### 完成情况

- 进度：测试BUG修复中（9.7）
- 预览地址：http://fedev.baidu.com/~wangpei07/mip/fit-text/fit-text-mip.html

#### 效果图

- 暂无
    
### 7、mip-fx-flying-carpet

    描述：未来显示全屏广告，在页面上使用一个固定高度的窗口来看全屏的广告内容

    进度：目前看来，实现方案在 wise 上兼容性有问题，完成的版本的方案，全屏的广告不能支持子链跳转，硬伤

        amp 的方案是第一版开发完，可是在国内的浏览器兼容性不是很理想，需要考虑更优方案

### 8. mip-form

#### 背景与目标
    
    input 增加 关闭按钮，一键清除文案功能

#### 完成情况

- 进度：开发中
- 预览地址：暂无

#### 效果图

- 暂无

  
## 文档 

#### 背景与目标
    
    为mip发版准备完善的文档
    
#### 完成情况

    - 增加 mip-fixed 组件说明
    - 禁止适用 style 属性，增加说明，同时梳理官网 demo
    - https url cache 需要转换文档说明，不对外开放，未同步官网
    - mipmain.js 版本升级同步文档