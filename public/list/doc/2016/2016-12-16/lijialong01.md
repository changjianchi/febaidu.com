# 李佳隆

> 从2016-12-09到2016-12-16


## 心跳探活算法升级(无更新)

### 背景

* 目前的心跳序列是以斐波拉契数列，越往后误差越大。对时长统计的准确性有莫大影响。

### 问题

* 斐波拉契数列误差大

### 方案

* 刘昭成通过数据建模，结合大数据得出新的探活序列

* 配合新算法，前端需改动架构。

### 进展

* 已经实现前端新算法的纯heart版demo

* <span>开发中</span>

* <span>基本开发完毕，下周qa接入测试</span>

* <span>11.29日小流量上线，开始实验评估</span>

* <span>在前100s，实验组比对照组时长多0.2s左右，100s后，实验组比对照组少5s。尝试了反转实验，结果仍旧一致。目前昭成在看训练结果的有效性是否有问题，再做进一步的规划。</span>


## 端上可以性监控

### 背景

* 今年出现了好几次大case，如手百异步白屏，死链等。op监控方完全没有任何察觉。故发起本项目,集合各方资源做到及时监控。

### 问题

* 许多case监控力度不够

* 监控复杂需要各方协作

### 预期

* 覆盖80%的异常case，及时监控报警。

### 进展

* 和手百同学勾兑，

* 完成了webb统一异常模块的开发。

* 已上线


## 糯米sdk调起统计丢失

### 背景

* wise导流由手百搜索卡片跳转h5再拉起sdk, 更改为手百搜索卡片直跳sdk后, 由于中间页存在tc日志统计, 现已失效, 会导致卡片动态排序靠后, 影响导流.

### 问题

* 糯米模板使用最原始的方式调起sdk

* zhidao模板是用的封装好的插件，支持发送tc日志

### 方案

1. 手百搜索卡片点击时, 增加传递统计url至糯米server, 糯米server做一次请求, 实现tc统计

2. 迁移插件为大搜标准,有成本

### 进展

* 先后多次沟通方案1会被认为是作弊故放弃

* <span>与手百的同学沟通，最终方案为在当前代码基础上添加统计参数，(底层支持). 下周一糯米fe开发测试</span>

* <span>糯米fe正在修改涉及的12个模板</span>

* <span  style="color:red;">等待评估</span>


## sendLog 升级

### 背景

* 目前有横滑调起sf2.0页面的case, 但是打的是交互日志，且没有src字段。

### 问题

* sendLog 发送日志没有src字段

### 进展

* 开发完毕，已上线。模板fe也完成了修复升级。

* <span color:red;></span>修复ct cst参数，由A.log.send 改为B.log.send

## webb skeleton.js 迁移

### 背景

* 只有webb-disp.js在使用skeleton.js,且很老了

### 进展

* <span style="color:red;"></span>重构skeletion.js 到webb-disp


## sf2.5添加disp逻辑

### 背景

* sf2.5是另外一套逻辑，没有发送webb展现日志

### 进展

* 今天与sf同学勾兑方案



## 日志自动化测试(无更新)

### 背景


* 增强日志稳定性,自动化测试日志(无更新)


### 完成情况

* <span>目前已完成webb日志的接口测试用例,日志内容测试用例后续迭代</span>
* <span>下周和雨梅对下怎么接入他们的测试框架,在www上线的时候监控日志</span>
* <span>雨梅休假,下周再对一下详细方案</span>
* <span>调整了方案,改为注入测试,以监控www-wise上线对日志的影响,开发中</span>
* <span>完善测试用例，修复phantomjs程序bug。基本完成接口测试内容, 下周和雨梅对一下内容测试的方案.</span>
* <span>添加测试内容必选字段是否合法，测试模拟发送时机</span>
* <span>接入karma管理测试，支持代码覆盖率报表. 完善测试用例中,总进度60%</span>
* <span>在雨梅机器上搭建测试环境，整合进www-wise的ci流程。</span>
* <span>完善测试用例<span>

## wise webb重构 (无更新)

### 背景

* 以前的webb.js代码比较老旧,逻辑太复杂,可读性非常差. 但后续要对webb日志进行重大功能升级, 重构代码是一项必不可少的工作,也为今后的功能升级打好基础.

* 目前日志模块没有统一的测试用例,测试需人工测试,无法完整覆盖测试的风险较高.

### 目标

* 提取功能性,有明确输入输出的方法 -> 简化逻辑提高可读性

* 重构部分实现 -> 让代码更合理,可读性更强

* 添加完整注释 -> 增强可读性

* 引入测试框架编写测试用例 -> 提高代码健壮性. 减轻测试压力


### 进展

* 7.4 开始重构

* 7.7日抽样上线 

* <span>针对web.js的底层日志逻辑,写了测试用例</span>

* <span>将日志存储拆分为一个模块,公共方法拆分为一个模块</span>

* <span> ubs还没给出结论,已看过2天的数据,正常波动. 还需要看1天的数据,无问题后转全</span>

* <span>首版实验结论是不明显负向,迭代了一版,下周出实验结论</span>

* <span>重做了全局实验,已上线,预计下周出结论</span>

* <span>ubs 同学休假了,下周给结论</span>

* <span>修复一个bug,继续实验</span>

* <span>可能实验流量有问题，修改流量为5% ,继续实验</span>

* <span>hadoop集群挂了，数据没跑出来</span>

* <span>实验符合预期，预计下周全量</span>

* <span>已全量，待分析影响结果</span>

* <span>配合异步机制，重构webb-ia 逻辑，改成单例模式</span>

* >重构webb的数据结构，改为qid+did+query 为key ，上线抽样模板，观察时长影响</span>

* <span>修改bug，继续试验</span>



## 日志本地存储/发送机制(无更新)

### 背景

* 页面在卸载（如用户关闭浏览器标签、点击链接跳转）时，日志可能会受到浏览器策略影响发送失败，卸载日志比例仅有xx%。所以，我们需要建立一个日志本地存储/发送机制，将待发送的日志写入本地存储，日志成功接收后（服务端返回成功码）从存储队列里删除。若期间出现页面卸载，则在下次用户进入页面的时候继续发送。

### 目标 

* 目前丢失率为27% , 目标将卸载日志成功率提升至10%。

### 进展

* 7.8 开始调研 , 7.11 开始开发, 7.15代码上线, 7.20 完成效果验证

* <span>将unload发送日志,改为onbeforeunload事件发送日志</span>

* <span>添加本地存储功能,所有日志操作均会同步本地缓存. 代码已上线,待测试</span>

* <span>已全量，待分析影响结果</span>

* <span>上线后丢失率增高，分析原始日志发现以didmerge的日志，然而补发的日志用的新的did，看能否紧急修复，不行就让时长的统计先不包含type=4的</span>

* <span>ubs 那边开发统计type=4的还没有上线，先上线type=2，修复了did不同的问题。丢失率没有增高，type=2增加，需要再看看是什么问题导致</span>

* <span>日志增加，但是丢失率有略微上升，目前在跑原始数据分析</span>



## 媒体时长监控 （无更新）

### 背景 

* 近期出现了多次时长问题，其中有手百8.0的上线，有异步机制的上线。目前并没有有效手段覆盖手百的发版，以及www-wise其他代码上线对时长的影响。上线之前都是未知的，上线之后，至少要延时1天才能产出时长数据，极大的延误了问题的发现与修复。

### 问题

* 虽然webb添加了单元测试，但测不了内容,以及规避其他机制产生的影响。缺少线下的时长测试机制。
* 时长的产出太慢，延误了问题的发现与修复

### 方案

* 引入qa线下时长测试
    1. 约定测试场景，和场景对应的考察指标标准
    2. qa自动化输入场景，对比标准测试(前期人工测试)
    3. 手百发版之前和www-wise的重大上线必须经过qa的时长测试


* 媒体时长实时监控，在1小时内能反映时长变化
    1. ubs给出影响时长产出速度的关键因素，共同推进解决


### 进展

* 已产出一份qa 的checklist，以及考察指标报表。

* <span >qa已经产出一版测试报告，初步看8.1符合预期。下周qa会再产出一版更新后的测试报告。同时加上费东的单pv时长脚本<span>

* <span>最新测试报告，符合8.1版本预期。费东提供了单pv时长统计的脚本，qa下周产出时长统计<span>

* <span>最新测试报告，符合8.1版本预期。费东提供了单pv时长统计的脚本，qa下周产出时长统计<span>



