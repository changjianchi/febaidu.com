# 李浪波

> 从2016-10-08到2016-10-14           

## 本周相关工作和 mip 规范

1. mip-validator 校验规则【无更新】

    背景与目标

        mip-validator 是一个支持 npm 安装，同时支持网页校验的 MIP 校验工具， 校验规则就是为校验工具提供一套符合 MIP 规范的规则。

    完成情况

    - 校验规则升级

        ```
        1. 不允许 html 标签中含有 style 属性

        2. 不允许 html 标签中含有 on开头的属性（如onclick），但是允许适用 on

        规则升级，a 标签 href 属性 支持：

        - tel:xxx
        - mailto:xxx
        ```

    - spider校验框架长线方案

        统一部署 NPM 包，10.27 fe 提供 http 和 tcp 版本

2、涉及规范更新：
    
    已上线官网说明，并同步给站长修改

    ```
        <link rel="standardhtml"
         href="https://m.baidu.com/static/ala/mip/mip-demo.html”>
        变成
        <link rel="canonical"
         href="https://m.baidu.com/static/ala/mip/mip-demo.html”>

        修改原因：
        符合w3c 规范
        rel=”canonical” 这个标签已经推出很久了，canonical 是 Google、雅虎、微软等搜索引擎一起推出的一个标签，它的主要作用是用来解决由于网址形式不同内容相同而造成的内容重复问题。这个标签对搜索引擎作用非常大，简单的说它可以让搜索引擎只抓取你想要强调的内容。

        整体节奏：
        1、@程刚 支持识别canonical标签的 h5页和 MIP 页对应，辛苦给下工作量和排期
        2、官网同步规范更改通知，并给出切换成<link rel=“canonical" 的 deadline
         @王培 @佳莹 ，
        与此同时，@张灿辛苦通知站长进行同步修改，务必在
         deadline 之前改完
        3、前后端两个校验模块更新
        @王培 @孙权 校验在 10月30号 时需要支持如下逻辑： 
        mip页 不能缺少<link rel=“canonical” ，
        但同时页面如果有<link rel="standardhtml”也是能通过验证
    ```

3、广告：
    1）网盟10月13号数据summary：总收入下降，点击下降率和消费下降率有diff；网盟鲁帅反馈上线时间13号13点38分上线，数据量少，不置信，鲁帅15号邮件反馈14号整天的数据。待出进一步数据
    2）通过4天百度统计验证，实验组比对对照组PV明显增长，增长幅度在12%~14%左右。待收入实验完毕后，转为空转流量进行佐证。
    3）百度统计：例行天级更新数据
    4）问题进展：
    
        I、广告速度：
            i、  13号晚上12点广告脚本预加载完成上线；
            ii、 广告脚本打包减少串行时间进行中，已经修改完成，120ask 也同步修改完成；
            iii、网盟合作优化：短线方案减少投放脚本体积，待网盟排期；长线方案持续进行中
        II、反作弊机制：
            支持网盟反作弊5.0方案，网盟下周末 ready 上线，mip 组件支持方案已敲定，下周开发两天，周三上线
            站点修改说明书，下周二 ready
        III、UC：
            广告屏蔽存在 diff，实验流量屏蔽掉 UC 浏览器，11号已上线
            120ask自有广告20s load问题由于情况复杂，结论已经邮件给出，和 jquery 的异步 require 和 UC 的智能云加速强相关
        IV、 网盟悬浮广告长线方案：
            方案已敲定，待反作弊支持5.0后排期开发

4、top 站点：

    1) 审批通过2个，并已经提交回归测试

        待审批3个

5、mip cache url 改写 已上线。下周上线对 url 全路径的改写

    背景：

        目前 mip 页走 mip cache，如果 http 请求用'/'打头，会去找 cache 的域名，导致404，需要 cache 将这些规则的地方加上全路径

    进展：

        需要支持改写的规则 list 已经提供给 OP 陈刚，cache 改写已经上线了初版

        本周支持css的 background-image

        存在问题：

            mip-ad 广告的 src 属性未支持，由于资讯的 mip-ad 的规范和我们不一致，需要@陈锐迁移

6、mip aladdin 机制打通

        见下面单独的项目描述

## mip aladdin 机制打通

### 背景：

    在引入阿拉丁资源中，有部分的外跳链接是 MIP 化的页面，可以使用 MIP 页在结果页打开的方式。例如目前线上 query:"奥运” 的阿拉丁结果（并非自动打标，而是硬编码到数据中）
    MIP 页有严格的规范，可以参照上面的 MIP 介绍，需要进行严格的打标记、屏蔽、退化等方式保证线上的良好用户体验

### 排期计划：
    
    排期为：
        10.17 ~ 10.21  编码
        10.24 ~ 10.28  测试
        10.31 ~ 11.4   前后端的联调
        11.7 ~ 11.11   上线

    具体分模块排期：

        建库工作        （雷杰），        9月19日可以启动，    10月21日完成开发测试工作
        错误日志回写 （孙巍巍），        非核心依赖，        依赖阿拉丁死链检测长线方案，短线先不支持
        平台工作        （浩玮），        10月初可以启动，     10月底完成相关开发测试工作
        Spdier           （孙权），        10月18号可以启动，   11月初完成相关开发测试工作
        AE相关工作    （陈刚，晓辉）， 非主要路径，             9月16日前完成具体工作的方案确认

### 进展：

    ```
        tera部分：目前每天处理流量40亿，现有机器106台，MIP按1000万来算的话无需新增机器应该也能接受
        处理模块：
         目前mip数据部署是和其他数据分开部署，message server需要新增一台机器，回灌模块需要新增1台机器，数据处理模块需要新增一台机器
        
        整体新增3台机器即可
    ```

    错误日志回写:
        讨论了在 GSS/ala-root/US/odp/模板的现有情况的可行性，结论是都不能快速短线支持，由于阿拉丁架构在推阿拉丁死链检测，也是同一波 RD 开发，和这个需求类似，所以结论是和阿拉丁死链检测同时进行，长线计划需巍巍给出排期，目前看年底有可能

    MIP阿拉丁的检测详细方案:

    ```
        阿拉丁：
            （1）       建库时，取站长认为符合mip规范的xml里的原始url，调用spider提供的基于Tera的mip类型的查询api接口，得到该url是检测过符合mip规范，检测过不符合mip规范，未检测等状态，用于确认是否能以mip形式进行展示。
            （2）       对于建库集合，基于自己的需求，如页面是否变化，是否进行去重等，过滤出待检测的阿拉丁url集合
            （3）       调度spider提供的抓取检测api，发送到Spider进行抓取。
        Spider：
            （1）       主要提供两个API接口：
            查询MIP类型的接口，查询Tera表里这个url的mip状态等提供，秒级返回；
            抓取检测API接口，接收阿拉丁的检测需求。
            （2）       MIP检测功能开发：
            存储上：实时死链系统，新建Tera表，存储阿拉丁的url符合mip规范的信息，上次检测时间等，并设置一定时间的TTL。
            开发上：接收阿拉丁的检测需求，发送到spider进行抓取检测；
            对于阿拉丁来源，且符合MIP规范的url，实时写入Tera中。
            检测上，spider还是会基于站点的压力控制，进行均衡的抓取，避免把站点抓挂的情况。
    ```

        流程如下图：
![image](http://gitlab.baidu.com/psfe/ala-weeklyreport/uploads/b5403c0435d30828077c83553579e0da/image.png)

        Mip url年底大概在5000w（总量*5%） 左右，按照更新频率、增量验证等因素来看，每天需要送检的大概在20%左右，大概1000w

### 阿拉丁接入短线方案：
    
    各个资源方着急自己所负责的mip资源上线，可以按照奥运的方案上线:阿拉丁的 mip url 标记完全由 xml 控制，直接站长标记

    缺点：
        1、mip 合法性和规范性无法保证，存在不符合规范也会展现到线上的风险，各资源方需要人工check资源的风险性；
        2、长线方案OK之后，需要迁移数据。

    优点：可以即时上线。





## 核心代码(齐健)

    基础代码完善  
```
1、联调核心代码和组件编译工具 - done  
2、核心代码编译工具升级支持dev、test模式 - done　
3、写组件示例 - done  
4、组件迁移 - doing。周五完成，下周提测 
```

## 组件  

    mip-form：增加输入框删除内容的 icon 交互功能，已上线
    mip-lightbox：核心代码依赖，测试中
    mip-sidebar：测试中
    mip-fit-text：10.20已上线。
    mip-stats-tianrun：10.20已上线。
    mip-ad：增加反作弊5.0功能，已上线
    mip-video: 优化，去掉复杂的广告逻辑和 pmd 依赖，代码精简符合内置组件要求，10.18上线完成
    mip-img：优化，增加默认背景。10.19号提测，测试中
    mip-list、mip-mustache 计划开发中
    上线：2个新增、3个优化。测试中：3个。开发中：2个


### 1. 校验规则

#### 背景与目标

    mip-validator 是一个支持 npm 安装，同时支持网页校验的 MIP 校验工具， 校验规则就是为校验工具提供一套符合 MIP 规范的规则。

#### 完成情况

- 进度：

    ```
        规则升级，a 标签 href 属性 支持：

        - tel:xxx
        - mailto:xxx
    ```

### 2. Aladdin 组件卡片（标准摘要）

#### 背景与目标
    
    提高模板利用率，开发通用模板卡片

#### 完成情况

- 进度：完成上线（10.21）
- 预览地址：暂无

#### 效果图

<table>
    <tr>
        <td><img src='../2016-10-21/img/wangpei07/wp01.png' width="280"></td>
        <td><img src='../2016-10-21/img/wangpei07/wp02.png' width="280"></td>
        <td><img src='../2016-10-21/img/wangpei07/wp03.png' width="280"></td>
    </tr>
</table>

### 3. mip-form

#### 背景与目标
    
    input 增加 关闭按钮，一键清除文案功能

#### 完成情况

- 进度：已上线（10.20）
- 预览地址：http://fedev.baidu.com/~wangpei07/mip/form/form-mip.html

#### 效果图

<table>
    <tr>
        <td><img src='../2016-10-14/img/wangpei07/wp01.png' width="300"></td>
    </tr>
</table>

### 4. mip-lightbox

#### 背景与目标
    
    点击按钮展开浮层

#### 完成情况

- 进度：bug fix（依赖核心代码升级）
- 预览地址：http://fedev.baidu.com/~wangpei07/mip/lightbox/lightbox-mip.html

#### 效果图

<table>
    <tr>
        <td><img src='../2016-09-23/img/wangpei07/wp01.png' width="300"></td>
        <td><img src='../2016-09-23/img/wangpei07/wp02.png' width="300"></td>
    </tr>
</table>

### 5. mip-sidebar

#### 背景与目标
    
    通用侧边栏组件，支持左边侧边栏和右边侧边栏

#### 完成情况

- 进度：测试 BUG 修复中（10.13）
- 预览地址：http://fedev.baidu.com/~wangpei07/mip/sidebar/mip-sidebar.html

#### 效果图

<table>
    <tr>
        <td><img src='../2016-09-09/img/wangpei07/wp03.png' width="320"></td>
    </tr>
</table>

### 6. mip-fit-text（接@传梼）

#### 背景与目标
    
    自适应字体组件，根据屏幕窗口的变化能够自适应字体

#### 完成情况

- 进度：已上线（10.20）
- 预览地址：http://fedev.baidu.com/~wangpei07/mip/fit-text/fit-text-mip.html

##### 效果图

- 暂无

### 7. mip-stats-tianrun

##### 背景与目标
    
    天润统计组件，第三方统计组件

#### 完成情况

- 进度：已上线（10.20）
- 预览地址：暂无

#### 效果图

- 暂无

### 8. mip-ad

##### 背景与目标
    
    1. 广告组件增加 baidu-wm-ext 反作弊类型

    2. 异步请求改为同步inline，提高性能

#### 完成情况

- 进度：已上线（10.20）
- 预览地址：暂无

#### 效果图

- 暂无

  
## 文档 

#### 背景与目标
    
    为mip发版准备完善的文档
    
#### 完成情况

    - 更新对应的上线内容，更新规范调整